# syntax=docker/dockerfile:1

# Dockerfile for GLPI
# Compile : docker build -t glpi .
# Build multiplateform : docker buildx build --push --platform linux/386,linux/amd64,linux/arm/v6,linux/arm64,linux/arm --tag glpi .

#ENV TZ TimeZone, please select a format PHP understands, a list can be generated by running ls /usr/share/zoneinfo.

FROM alpine:latest

ENV NODE_ENV=production

# Variables for versions
ENV GLPI_VERSION="9.5.6"
ENV PLUGIN_ACCOUNT_VERSION="2.6.0"
ENV PLUGIN_ADDRESSING_VERSION="2.9.0"
ENV PLUGIN_FIELDS_VERSION="1.12.8"
ENV PLUGIN_FUSIONINVENTORY_VERSION="9.5+3.0"
ENV PLUGIN_MANAGEENTITIES_VERSION="3.2.2"
ENV PLUGIN_MANUFACTURESIMPORTS_VERSION="2.3.1"
ENV PLUGIN_MREPORTING_VERSION="1.7.3"
ENV PLUGIN_NEWS_VERSION="1.9.0"
ENV PLUGIN_REPORTS_VERSION="1.14.1"

RUN apk --no-cache upgrade \
    && apk add --no-cache mariadb-client \
                          php7 \
						  php7-curl php7-fileinfo php7-gd php7-json php7-mbstring php7-mysqli php7-session php7-zlib \
						  php7-simplexml php7-xml php7-intl php7-dom php7-xmlrpc php7-soap \
						  php7-ldap php7-pecl-apcu php7-ctype php7-sodium php7-snmp \
						  php7-exif php7-phar php7-zip php7-bz2 php7-opcache php7-pear php7-iconv php7-pdo \
						  nmap perl perl-net-snmp perl-crypt-des perl-digest-hmac wget inotify-tools

# Working directory to root
WORKDIR /root

# Install GLPI & plugins
RUN mkdir -p /var/www/glpi \
	&& addgroup -g 101 apache \
	&& adduser -u 100 -H -D -h /var/www -s /sbin/nologin -G apache -g 'apache' apache \
	&& wget https://github.com/glpi-project/glpi/releases/download/${GLPI_VERSION}/glpi-${GLPI_VERSION}.tgz \
    && tar xzf glpi-${GLPI_VERSION}.tgz \
	&& cp -a glpi /var/www/ \
	&& rm glpi-${GLPI_VERSION}.tgz \
	&& mkdir plugins \
	&& cd plugins \
	&& wget https://github.com/InfotelGLPI/accounts/releases/download/${PLUGIN_ACCOUNT_VERSION}/glpi-accounts-${PLUGIN_ACCOUNT_VERSION}.tar.gz \
	&& tar xzf glpi-accounts-${PLUGIN_ACCOUNT_VERSION}.tar.gz \
	&& rm glpi-accounts-${PLUGIN_ACCOUNT_VERSION}.tar.gz \
	&& wget https://github.com/pluginsGLPI/addressing/releases/download/${PLUGIN_ADDRESSING_VERSION}/glpi-addressing-${PLUGIN_ADDRESSING_VERSION}.tar.gz \
	&& tar xzf glpi-addressing-${PLUGIN_ADDRESSING_VERSION}.tar.gz \
	&& rm glpi-addressing-${PLUGIN_ADDRESSING_VERSION}.tar.gz \
	&& wget https://github.com/pluginsGLPI/fields/releases/download/${PLUGIN_FIELDS_VERSION}/glpi-fields-${PLUGIN_FIELDS_VERSION}.tar.bz2 \
	&& tar xjf glpi-fields-${PLUGIN_FIELDS_VERSION}.tar.bz2 \
	&& rm glpi-fields-${PLUGIN_FIELDS_VERSION}.tar.bz2 \
	&& wget https://github.com/fusioninventory/fusioninventory-for-glpi/releases/download/glpi${PLUGIN_FUSIONINVENTORY_VERSION}/fusioninventory-${PLUGIN_FUSIONINVENTORY_VERSION}.tar.bz2 \
	&& tar xjf fusioninventory-${PLUGIN_FUSIONINVENTORY_VERSION}.tar.bz2 \
	&& rm fusioninventory-${PLUGIN_FUSIONINVENTORY_VERSION}.tar.bz2 \
	&& wget https://github.com/InfotelGLPI/manageentities/releases/download/${PLUGIN_MANAGEENTITIES_VERSION}/glpi-manageentities-${PLUGIN_MANAGEENTITIES_VERSION}.tar.gz \
	&& tar xzf glpi-manageentities-${PLUGIN_MANAGEENTITIES_VERSION}.tar.gz \
	&& rm glpi-manageentities-${PLUGIN_MANAGEENTITIES_VERSION}.tar.gz \
	&& wget https://github.com/InfotelGLPI/manufacturersimports/releases/download/${PLUGIN_MANUFACTURESIMPORTS_VERSION}/glpi-manufacturersimports-${PLUGIN_MANUFACTURESIMPORTS_VERSION}.tar.gz \
	&& tar xzf glpi-manufacturersimports-${PLUGIN_MANUFACTURESIMPORTS_VERSION}.tar.gz \
	&& rm glpi-manufacturersimports-${PLUGIN_MANUFACTURESIMPORTS_VERSION}.tar.gz \
	&& wget https://github.com/pluginsGLPI/mreporting/releases/download/${PLUGIN_MREPORTING_VERSION}/glpi-mreporting-${PLUGIN_MREPORTING_VERSION}.tar.bz2 \
	&& tar xjf glpi-mreporting-${PLUGIN_MREPORTING_VERSION}.tar.bz2 \
	&& rm glpi-mreporting-${PLUGIN_MREPORTING_VERSION}.tar.bz2 \
	&& wget https://github.com/pluginsGLPI/news/releases/download/${PLUGIN_NEWS_VERSION}/glpi-news-${PLUGIN_NEWS_VERSION}.tar.bz2 \
	&& tar xjf glpi-news-${PLUGIN_NEWS_VERSION}.tar.bz2 \
	&& rm glpi-news-${PLUGIN_NEWS_VERSION}.tar.bz2 \
	&& wget https://forge.glpi-project.org/attachments/download/2332/glpi-plugin-reports-${PLUGIN_REPORTS_VERSION}.tar.gz \
	&& tar xzf glpi-plugin-reports-${PLUGIN_REPORTS_VERSION}.tar.gz \
	&& rm glpi-plugin-reports-${PLUGIN_REPORTS_VERSION}.tar.gz
COPY glpi.cron /etc/crontabs/glpi.cron
COPY start_glpi-cron.sh .
RUN chmod go-rwx /etc/crontabs/glpi.cron \
	&& chmod u-x /etc/crontabs/glpi.cron \
	&& chmod a+x start_glpi-cron.sh

# Mount volumes persistence
VOLUME /var/www/glpi/config
VOLUME /var/www/glpi/files
VOLUME /var/www/glpi/plugins
VOLUME /var/www/glpi/marketplace

# Run Apache2
ENTRYPOINT ["/root/start_glpi-cron.sh"]